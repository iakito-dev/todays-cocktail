# 機能要件定義（Functional Requirements）

最終更新: 2025-11-06  
対象バージョン: API `/api/v1`, フロントエンド React 19 + Vite

---

## 1. プロダクト概要

Today’s Cocktail は、カクテル検索と学習を支援する個人開発アプリ。  
ユーザーはベース酒・材料・人気度でカクテルを探し、レシピ詳細やお気に入り機能を通じて自分だけのレパートリーを作ることを目指す。

---

## 2. アクター定義

| アクター | 説明 | 主な操作 |
| --- | --- | --- |
| ゲストユーザー | 未ログイン利用者 | カクテル検索・詳細閲覧・今日の一杯の閲覧 |
| 登録ユーザー | メール認証を完了したユーザー | お気に入り追加/削除、マイページで自分情報確認 |
| 管理者 | `users.admin = true` の登録ユーザー | カクテル情報の更新（名称・説明・画像URL等） |
| 外部サービス | Devise + JWT / Supabase | 認証・メール送信・データストア |

---

## 3. ユースケース一覧（必須機能）

### 3.1 カクテル検索・一覧表示
- **目的**: 条件に合うカクテルを一覧で確認。
- **前提**: Supabase から Rails API がカクテル情報を取得。
- **機能要件**
  - キーワード (`q`) による名称部分一致。
  - ベース酒 (`base`) の単体/複数指定フィルタ。
  - 材料 (`ingredients`) の AND 絞り込み。
  - ページネーション (`page`, `per_page=1〜100`)、人気順ソート (`sort=popular`) に対応。
  - レスポンスには日本語情報 (`name_ja`, `glass_ja`, `instructions_ja`) と画像URLを含む。

### 3.2 カクテル詳細閲覧
- **目的**: 1 件のカクテルの材料・手順を確認。
- **機能要件**
  - カクテル基本情報（英語/日本語）、説明、画像を表示。
  - 材料リストは `position` 順で並べ、英日両対応の分量を表示。
  - キャッシュが存在しない場合は API から再取得。
  - 存在しない ID アクセス時は 404 表示。

### 3.3 今日の一杯（ランダムレコメンド）
- **目的**: トップページに日替わりのおすすめを表示。
- **機能要件**
  - 毎日 1 件をランダムに選出し 24 時間キャッシュ。
  - カクテル詳細と同じ情報構造を返却。
  - カクテルが 0 件の場合は 404。

### 3.4 お気に入り管理（登録ユーザー）
- **前提**: ログイン中（有効な JWT を保持）。
- **機能要件**
  - 一覧: 自分が登録したお気に入りのみ表示。作成日時降順。
  - 追加: `cocktail_id` 指定で登録。重複時は 422（ユニーク制約）。
  - 削除: 自分が登録したお気に入りのみ削除可。存在しない ID は 404。
  - レスポンスにはお気に入り対象カクテルの詳細サマリを含め、`is_favorited=true` を明示。

### 3.5 認証フロー（Devise + JWT）
- **サインアップ**: `email`, `password`, `password_confirmation`, `name` で登録。成功時は確認メール送信。
- **メール確認**: トークン付き URL アクセスでユーザーを `confirmed` に設定し自動サインイン。
- **ログイン**: メール/パスワードで JWT を発行。未確認ユーザーは 401。
- **ログアウト**: JWT を denylist に登録し、同トークンでの再アクセスを拒否。
- **ユーザー情報取得**: `GET /users/me` でログインユーザーの `id/email/name/admin` を返却。

### 3.6 管理者更新機能
- **対象**: `PUT /api/v1/admin/cocktails/:id`
- **機能要件**
  - カクテルの英日名称、説明、技法、画像URL等を更新。
  - 更新後は詳細キャッシュ・一覧キャッシュ・今日の一杯キャッシュを削除。
  - 一般ユーザーのアクセスは 403。

---

## 4. 補助機能・非機能要件

### 4.1 非機能
- **レスポンス形式**: JSON（UTF-8）。バックエンドは Rails API、フロントは React から `fetch`/`axios` 経由で利用。
- **エラーハンドリング**: 認証系は `status` オブジェクトと `errors` を返し、カクテル系はシンプルな JSON＋HTTP ステータス。
- **キャッシュ**: Rails.cache を利用し、一覧 1 時間、詳細 24 時間、今日の一杯 1 日キャッシュ。
- **性能要件**: 一覧 API は 100 件までのバッチ取得、人気順ソートはお気に入り数のカウントを利用。
- **セキュリティ**: JWT は 24 時間有効、ログアウトで denylist に登録。メール未確認ユーザーはログイン不可。
- **ロギング**: 認証失敗や予期せぬ例外は Rails ログへ出力。

### 4.2 将来の Nice to Have
- 材料マスタの公開 API (`/ingredients`)。
- 画像アップロード（Active Storage 再導入）。
- レビュー・タグ付け・検索履歴保存などの拡張。
- Supabase Functions や Render/Vercel への自動デプロイ。

---

## 5. 画面との対応表

| 画面 | 対応 API | 主なコンポーネント |
| --- | --- | --- |
| トップページ | `GET /cocktails`, `GET /cocktails/todays_pick` | カードグリッド、フィルタパネル、今日の一杯 |
| カクテル詳細 | `GET /cocktails/:id` | 材料リスト、作り方セクション、お気に入りボタン |
| お気に入り一覧 | `GET /favorites` | お気に入りカードリスト |
| 認証（サインアップ/ログイン） | `POST /signup`, `POST /login`, `GET /confirmation`, `POST /confirmation` | フォーム、トースト通知 |
| 管理画面（暫定） | `PUT /admin/cocktails/:id` | 管理者向け編集フォーム（現状は API ベースで操作） |

---

## 6. テスト観点（要約）

- **API レベル**: RSpec によるリクエストスペック。検索条件、フィルタ、認証、メール未確認時の挙動、キャッシュ無効化などをカバー。
- **フロントエンド**: Vitest + Testing Library で UI コンポーネントとフックを検証（検索フォーム、状態遷移、API エラーハンドリングなど）。
- **E2E（検討中）**: Playwright/Cypress での結合テスト導入を将来検討。

---

この文書は実装と同期し、仕様変更があれば更新すること。更新時は最終更新日を必ず書き換える。***
