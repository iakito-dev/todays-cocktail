# ================================
# 🐳 Docker Compose 設定（Supabaseローカル接続用）
# ================================
# Supabase CLI（supabase start）で起動したDBを利用し、
# Docker上ではフロントエンド（React）とバックエンド（Rails）のみを起動する構成。

version: "3.9"

services:
  # -------------------------------
  # Rails API バックエンド
  # -------------------------------
  backend:
    build: ./backend
    ports:
      - "3000:3000"  # Rails APIサーバー (localhost:3000)
    environment:
      RAILS_ENV: development
      # Docker内からホストのSupabaseに接続
      DATABASE_URL: postgres://postgres:postgres@host.docker.internal:54322/app_development
      # Devise JWT認証用シークレットキー
      DEVISE_JWT_SECRET_KEY: ${DEVISE_JWT_SECRET_KEY}
    volumes:
      - ./backend:/app  # ローカルのコードをマウントしてホットリロード
    env_file:
      - ./backend/.env  # バックエンド専用の.envファイル
    # Rails初期化処理（PIDファイル削除・依存インストール・サーバ起動など）は
    # /app/bin/docker-startup スクリプトで実行します。詳細はスクリプト内コメント参照。
    command: bash /app/bin/docker-startup

  # -------------------------------
  # React / Vite フロントエンド
  # -------------------------------
  frontend:
    build: ./frontend
    ports:
      - "5173:5173"  # Vite開発サーバー (localhost:5173)
    environment:
      # バックエンドAPIとの通信先
      VITE_API_BASE_URL: http://localhost:3000
      # Supabase設定
      VITE_SUPABASE_URL: http://localhost:54321
      VITE_SUPABASE_ANON_KEY: dummy
    volumes:
      - ./frontend:/app
      - /app/node_modules
    env_file:
      - ./frontend/.env  # フロントエンド専用の.envファイル
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"

# DBサービスは削除（SupabaseローカルPostgreSQLを使用）
