#!/bin/bash
set -e

echo "ğŸš€ Starting Rails application..."

# ãƒªãƒˆãƒ©ã‚¤è¨­å®šï¼ˆç’°å¢ƒå¤‰æ•°ã§ä¸Šæ›¸ãå¯èƒ½ï¼‰
DB_PREPARE_MAX_RETRIES=${DB_PREPARE_MAX_RETRIES:-10}
DB_PREPARE_RETRY_WAIT=${DB_PREPARE_RETRY_WAIT:-5}

run_with_retry() {
  local cmd="$1"
  local attempt=1

  while true; do
    echo "ğŸ” Attempt ${attempt}/${DB_PREPARE_MAX_RETRIES}: ${cmd}"
    if eval "${cmd}"; then
      return 0
    fi

    if [ "${attempt}" -ge "${DB_PREPARE_MAX_RETRIES}" ]; then
      echo "âŒ Command failed after ${DB_PREPARE_MAX_RETRIES} attempts: ${cmd}"
      return 1
    fi

    attempt=$((attempt + 1))
    echo "â³ Waiting ${DB_PREPARE_RETRY_WAIT}s before retrying..."
    sleep "${DB_PREPARE_RETRY_WAIT}"
  done
}

# ã‚µãƒ¼ãƒãƒ¼PIDãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
rm -f tmp/pids/server.pid

# ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
echo "ğŸ“¦ Installing dependencies..."
bundle install

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æº–å‚™ï¼ˆå®Œäº†ã¾ã§ãƒªãƒˆãƒ©ã‚¤ï¼‰
echo "ğŸ—„ï¸  Preparing database (auto-migrate)..."
run_with_retry "bundle exec rails db:prepare"

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒç©ºã®å ´åˆã®ã¿Seedã‚’å®Ÿè¡Œ
COCKTAIL_COUNT=$(bundle exec rails runner "puts Cocktail.count" 2>/dev/null || echo "0")
if [ "$COCKTAIL_COUNT" -eq 0 ]; then
  echo "ğŸŒ± Seeding database (first time setup)..."
  bundle exec rails db:seed || echo "âš ï¸  Seeding failed, continuing..."
else
  echo "âœ… Database already seeded, skipping..."
fi

# Railsã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
echo "ğŸ‰ Starting Rails server..."
bundle exec rails s -b 0.0.0.0
