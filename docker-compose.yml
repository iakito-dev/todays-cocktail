# =========================================================
# ğŸ³ Docker Compose è¨­å®šï¼ˆColimaä½¿ç”¨ï¼‰
# =========================================================
# Supabase CLIã§èµ·å‹•ä¸­ã®ãƒ­ãƒ¼ã‚«ãƒ«DBã‚’ä½¿ç”¨ã€‚
# Colimaä¸Šã§Rails APIã¨React(Vite)ã‚’è»½é‡ãƒ»é«˜é€Ÿã«å®Ÿè¡Œã™ã‚‹æ§‹æˆã€‚
#
# ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§ï¼š
# åˆå›ï¼ˆã¾ãŸã¯Dockerfileå¤‰æ›´æ™‚ï¼‰
#   docker compose --profile dev up --build
#
# é€šå¸¸èµ·å‹•ï¼ˆãƒ“ãƒ«ãƒ‰æ¸ˆã¿ï¼‰
#   docker compose up -d
#
# åœæ­¢
#   docker compose down
#
# ãƒ­ã‚°ç¢ºèª
#   docker compose logs -f
# =========================================================

version: "3.9"

services:
  # ---------------------------------------------------------
  # Rails API ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
  # ---------------------------------------------------------
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"  # http://localhost:3000
    volumes:
      # ã‚³ãƒ¼ãƒ‰ã‚’ãƒ›ã‚¹ãƒˆã¨å…±æœ‰ã€‚:cachedã§I/Oã‚’æœ€é©åŒ–
      - ./backend:/app:cached
      # ä¸€æ™‚ãƒ»ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ãƒ›ã‚¹ãƒˆã¨åŒæœŸã—ãªã„
      - /app/tmp
      - /app/log
    env_file:
      - ./backend/.env
    # RailsåˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆPIDå‰Šé™¤ãƒ»ä¾å­˜ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ»ã‚µãƒ¼ãƒèµ·å‹•ï¼‰
    command: bash /app/bin/docker-startup
    # Colimaä¸Šã§ã®CPUãƒ»ãƒ¡ãƒ¢ãƒªåˆ¶é™ï¼ˆè»½é‡åŒ–ï¼‰
    deploy:
      resources:
        limits:
          cpus: "1.5"
          memory: 1G
    profiles: ["dev"]

  # ---------------------------------------------------------
  # React / Vite ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
  # ---------------------------------------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "5173:5173"  # http://localhost:5173
    environment:
      # APIã¨Supabaseã®æ¥ç¶šè¨­å®šï¼ˆé–‹ç™ºç”¨ï¼‰
      VITE_API_BASE_URL: http://localhost:3000
      VITE_SUPABASE_URL: http://localhost:54321
      VITE_SUPABASE_ANON_KEY: dummy
    volumes:
      # ã‚³ãƒ¼ãƒ‰åŒæœŸã€‚:cachedã§ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°ã‚’é«˜é€ŸåŒ–
      - ./frontend:/app:cached
      # node_modulesã¯ã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Œçµã•ã›ã‚‹ï¼ˆåŒæœŸã—ãªã„ï¼‰
      - /app/node_modules
    env_file:
      - ./frontend/.env
    # npm ciã§ä¾å­˜é–¢ä¿‚ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« â†’ Viteé–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
    command: sh -c "npm ci && npm run dev -- --host 0.0.0.0"
    # Colimaä¸Šã§ã®CPUãƒ»ãƒ¡ãƒ¢ãƒªåˆ¶é™
    deploy:
      resources:
        limits:
          cpus: "1.5"
          memory: 1G
    profiles: ["dev"]
