#!/bin/bash
set -e

echo "ğŸš€ Starting Rails application..."

# ã‚µãƒ¼ãƒãƒ¼PIDãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
rm -f tmp/pids/server.pid

# ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
echo "ğŸ“¦ Installing dependencies..."
bundle install

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æº–å‚™ï¼ˆã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–ï¼‰
echo "ğŸ—„ï¸  Preparing database..."
bundle exec rails db:prepare || echo "âš ï¸  Database prepare failed, continuing..."

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒç©ºã®å ´åˆã®ã¿Seedã‚’å®Ÿè¡Œ
COCKTAIL_COUNT=$(bundle exec rails runner "puts Cocktail.count" 2>/dev/null || echo "0")
if [ "$COCKTAIL_COUNT" -eq 0 ]; then
  echo "ğŸŒ± Seeding database (first time setup)..."
  bundle exec rails db:seed || echo "âš ï¸  Seeding failed, continuing..."
else
  echo "âœ… Database already seeded, skipping..."
fi

# Railsã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
echo "ğŸ‰ Starting Rails server..."
bundle exec rails s -b 0.0.0.0
